<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search Event Taxonomy - Device Breakout</title>
  <script src="https://extensions.tableauusercontent.com/resources/tableau.extensions.1.latest.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #f7f7f7; color: #1a1a1a; padding: 24px; }
    h1 { font-size: 16px; font-weight: 600; margin-bottom: 6px; }
    .subtitle { font-size: 11px; color: #666; margin-bottom: 12px; }
    .loading { text-align: center; padding: 40px; font-size: 14px; color: #666; }
    .error { background: #fee; border: 1px solid #c00; color: #c00; padding: 16px; border-radius: 8px; margin: 20px 0; }
    .filter-bar { display: flex; gap: 16px; margin-bottom: 16px; align-items: center; flex-wrap: wrap; }
    .filter-group { display: flex; gap: 8px; align-items: center; }
    .filter-label { font-size: 10px; font-weight: 600; text-transform: uppercase; color: #666; }
    .filter-btn { padding: 6px 12px; font-size: 10px; font-weight: 600; border: 2px solid #ddd; border-radius: 6px; background: #fff; cursor: pointer; }
    .filter-btn:hover { border-color: #999; }
    .filter-btn.active { background: #1a1a1a; color: #fff; border-color: #1a1a1a; }
    .filter-btn.global-btn.active { background: #00cdbe; border-color: #00cdbe; color: #1a1a1a; }
    .filter-btn.navigation-btn.active { background: #f5a623; border-color: #f5a623; color: #1a1a1a; }
    .filter-btn.specific-btn.active { background: #888; border-color: #888; color: #fff; }
    .section { background: #fff; border: 2px solid #1a1a1a; border-radius: 12px; padding: 16px; margin-bottom: 20px; }
    .section.hidden { display: none; }
    .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .section-label { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; padding: 4px 10px; border-radius: 4px; }
    .section-title { font-size: 14px; font-weight: 600; }
    .section-desc { font-size: 10px; color: #666; }
    .global .section-label { background: #00cdbe; color: #1a1a1a; }
    .global { border-color: #00cdbe; }
    .navigation .section-label { background: #f5a623; color: #1a1a1a; }
    .navigation { border-color: #f5a623; }
    .specific .section-label { background: #888; color: #fff; }
    .specific { border-color: #888; }
    .device-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .device-card { background: #fafafa; border-radius: 8px; padding: 12px; border: 1px solid #e0e0e0; }
    .device-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #ddd; }
    .device-name { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .device-users { font-size: 9px; color: #666; }
    .device-users .engaged { font-weight: 700; color: #1976d2; }
    .device-users .total { color: #888; }
    .global .device-header { border-bottom-color: #00cdbe; }
    .navigation .device-header { border-bottom-color: #f5a623; }
    .specific .device-header { border-bottom-color: #888; }
    .metric-table { width: 100%; border-collapse: collapse; font-size: 9px; }
    .metric-table th { text-align: left; padding: 4px 3px; font-size: 7px; font-weight: 600; color: #888; text-transform: uppercase; border-bottom: 1px solid #ddd; }
    .metric-table th:not(:first-child) { text-align: right; }
    .metric-table td { padding: 4px 3px; border-bottom: 1px solid #eee; }
    .metric-table td:not(:first-child) { text-align: right; font-family: 'SF Mono', Monaco, monospace; font-size: 8px; }
    .metric-table .outcome { font-weight: 500; color: #333; }
    .metric-table .events { font-weight: 700; color: #1a1a1a; }
    .metric-table .users { color: #1976d2; font-weight: 600; }
    .metric-table .util { color: #1976d2; font-weight: 600; }
    .metric-table .int { color: #7c3aed; font-weight: 600; }
    .metric-table .total-row { font-weight: 700; border-top: 2px solid #ccc; background: #f5f5f5; }
    .footer { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-top: 20px; }
    .legend { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; font-size: 9px; line-height: 1.8; }
    .legend strong { color: #333; }
    .legend .util { color: #1976d2; }
    .legend .int { color: #7c3aed; }
    .users-card { background: #e8f4fc; border: 1px solid #90caf9; border-radius: 8px; padding: 12px; }
    .users-card strong { font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; color: #333; display: block; margin-bottom: 8px; }
    .users-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .user-stat { text-align: center; padding: 6px; background: rgba(255,255,255,0.7); border-radius: 4px; }
    .user-stat .device { font-size: 8px; color: #666; }
    .user-stat .count { font-size: 12px; font-weight: 700; color: #1565c0; font-family: 'SF Mono', Monaco, monospace; }
    .data-status { background: #e8f5e9; border: 1px solid #4caf50; border-radius: 6px; padding: 4px 10px; font-size: 10px; font-weight: 600; color: #2e7d32; }
  </style>
</head>
<body>
  <div id="app"><div class="loading">Loading...</div></div>

  <script>
    var dashboardData = {
      devices: ['Desktop', 'mWeb', 'iOS', 'Android'],
      buckets: {
        'GLOBAL_SEARCH': { label: 'Search', title: 'Global Search', desc: 'User typed a query', css: 'global' },
        'NAVIGATION_SEARCH': { label: 'Navigation', title: 'Navigation Search', desc: 'No query typed — search bar used as navigation shortcut', css: 'navigation' },
        'SPECIFIC_SEARCH': { label: 'Surface-Specific', title: 'Specific Search', desc: 'Search-adjacent functionalities', css: 'specific' }
      },
      totalUsers: {},
      metrics: {}
    };

    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
      if (num >= 1000) return Math.round(num / 1000) + 'K';
      return num.toString();
    }

    function parseData(data) {
      var cols = {};
      data.columns.forEach(function(c, i) {
        cols[c.fieldName.toLowerCase().replace(/[\s_]/g, '')] = i;
      });

      dashboardData.metrics = {};
      dashboardData.totalUsers = {};

      data.data.forEach(function(row) {
        var device = row[cols['device']].value;
        var bucket = row[cols['searchbucket']].value;
        var outcome = row[cols['outcometype']].value;
        var events = parseFloat(row[cols['eventcount']].value) || 0;
        var users = parseFloat(row[cols['uniqueusers']].value) || 0;
        var total = parseFloat(row[cols['totalusers']].value) || 0;
        var pct = parseFloat(row[cols['pctusersengaged']].value) || 0;
        var intensity = parseFloat(row[cols['intensity']].value) || 0;

        dashboardData.totalUsers[device] = total;

        var key = device + '|' + bucket;
        if (!dashboardData.metrics[key]) {
          dashboardData.metrics[key] = { device: device, bucket: bucket, outcomes: [], totalEvents: 0, totalUsers: 0 };
        }
        dashboardData.metrics[key].outcomes.push({ outcome: outcome, events: events, users: users, pct: pct, intensity: intensity });
        dashboardData.metrics[key].totalEvents += events;
        dashboardData.metrics[key].totalUsers += users;
      });

      Object.keys(dashboardData.metrics).forEach(function(k) {
        dashboardData.metrics[k].outcomes.sort(function(a, b) { return b.events - a.events; });
      });
    }

    function render() {
      var html = '<h1>Search Event Taxonomy — Device Breakout</h1><div class="subtitle">Desktop vs mWeb vs iOS vs Android</div>';
      html += '<div class="filter-bar"><div class="filter-group"><span class="filter-label">Bucket:</span>';
      html += '<button class="filter-btn active" onclick="filter(\'all\')">All</button>';
      html += '<button class="filter-btn global-btn" onclick="filter(\'global\')">Global Search</button>';
      html += '<button class="filter-btn navigation-btn" onclick="filter(\'navigation\')">Navigation</button>';
      html += '<button class="filter-btn specific-btn" onclick="filter(\'specific\')">Specific</button>';
      html += '</div><div class="data-status">Live from Tableau</div></div>';

      ['GLOBAL_SEARCH', 'NAVIGATION_SEARCH', 'SPECIFIC_SEARCH'].forEach(function(bucketKey) {
        var info = dashboardData.buckets[bucketKey];
        html += '<div class="section ' + info.css + '" data-bucket="' + info.css + '">';
        html += '<div class="section-header"><div class="section-label">' + info.label + '</div><div><div class="section-title">' + info.title + '</div><div class="section-desc">' + info.desc + '</div></div></div>';
        html += '<div class="device-grid">';

        dashboardData.devices.forEach(function(device) {
          var key = device + '|' + bucketKey;
          var m = dashboardData.metrics[key];
          var totalDevice = dashboardData.totalUsers[device] || 0;

          html += '<div class="device-card"><div class="device-header"><span class="device-name">' + device + '</span>';
          html += '<span class="device-users"><span class="engaged">' + (m ? formatNumber(m.totalUsers) : '-') + '</span>/<span class="total">' + formatNumber(totalDevice) + '</span></span></div>';
          html += '<table class="metric-table"><thead><tr><th>Outcome</th><th>Events</th><th>Users</th><th>%Engaged</th><th>Per User</th></tr></thead><tbody>';

          if (m && m.outcomes.length > 0) {
            m.outcomes.forEach(function(o) {
              html += '<tr><td class="outcome">' + o.outcome + '</td><td class="events">' + formatNumber(o.events) + '</td><td class="users">' + formatNumber(o.users) + '</td><td class="util">' + o.pct.toFixed(2) + '%</td><td class="int">' + o.intensity.toFixed(1) + '</td></tr>';
            });
            html += '<tr class="total-row"><td class="outcome">TOTAL</td><td class="events">' + formatNumber(m.totalEvents) + '</td><td class="users">' + formatNumber(m.totalUsers) + '</td><td>-</td><td>-</td></tr>';
          } else {
            html += '<tr><td colspan="5" style="text-align:center;color:#ccc;">No data</td></tr>';
          }
          html += '</tbody></table></div>';
        });
        html += '</div></div>';
      });

      html += '<div class="footer"><div class="legend"><strong>Metric Definitions</strong><br><strong>Events</strong> = gross event count<br><span class="util"><strong>Users</strong></span> = distinct users who performed this action<br><span class="util"><strong>%Engaged</strong></span> = % of device users who engaged with this outcome<br><span class="int"><strong>Per User</strong></span> = events per engaged user</div>';
      html += '<div class="users-card"><strong>Total Users by Device</strong><div class="users-grid">';
      dashboardData.devices.forEach(function(d) {
        html += '<div class="user-stat"><div class="device">' + d + '</div><div class="count">' + formatNumber(dashboardData.totalUsers[d] || 0) + '</div></div>';
      });
      html += '</div></div></div>';

      document.getElementById('app').innerHTML = html;
    }

    window.filter = function(f) {
      document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
      event.target.classList.add('active');
      document.querySelectorAll('.section').forEach(function(s) {
        s.classList.toggle('hidden', f !== 'all' && s.dataset.bucket !== f);
      });
    };

    // Initialize
    if (typeof tableau !== 'undefined') {
      tableau.extensions.initializeAsync().then(function() {
        var ws = tableau.extensions.dashboardContent.dashboard.worksheets[0];
        ws.getSummaryDataAsync().then(function(data) {
          parseData(data);
          render();
        });
        ws.addEventListener(tableau.TableauEventType.SummaryDataChanged, function() {
          ws.getSummaryDataAsync().then(function(data) { parseData(data); render(); });
        });
      });
    } else {
      document.getElementById('app').innerHTML = '<div class="error">Tableau API not loaded</div>';
    }
  </script>
</body>
</html>
