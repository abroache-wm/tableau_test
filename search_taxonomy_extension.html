<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search Event Taxonomy</title>
  <script src="https://extensions.tableauusercontent.com/resources/tableau.extensions.1.latest.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #f7f7f7; color: #1a1a1a; padding: 24px; }
    h1 { font-size: 16px; font-weight: 600; margin-bottom: 6px; }
    .subtitle { font-size: 11px; color: #666; margin-bottom: 12px; }
    .loading { text-align: center; padding: 40px; font-size: 14px; color: #666; }
    .error { background: #fee; border: 1px solid #c00; color: #c00; padding: 16px; border-radius: 8px; margin: 20px 0; }

    /* Control bar */
    .control-bar { display: flex; gap: 20px; margin-bottom: 16px; align-items: center; flex-wrap: wrap; }
    .control-group { display: flex; gap: 8px; align-items: center; }
    .control-label { font-size: 10px; font-weight: 600; text-transform: uppercase; color: #666; }

    /* View toggle */
    .view-toggle { display: flex; border: 2px solid #1a1a1a; border-radius: 6px; overflow: hidden; }
    .view-btn { padding: 6px 14px; font-size: 10px; font-weight: 600; border: none; background: #fff; cursor: pointer; }
    .view-btn:not(:last-child) { border-right: 2px solid #1a1a1a; }
    .view-btn:hover { background: #f0f0f0; }
    .view-btn.active { background: #1a1a1a; color: #fff; }

    /* Filter buttons */
    .filter-bar { display: flex; gap: 16px; margin-bottom: 16px; align-items: center; flex-wrap: wrap; }
    .filter-group { display: flex; gap: 8px; align-items: center; }
    .filter-label { font-size: 10px; font-weight: 600; text-transform: uppercase; color: #666; }
    .filter-btn { padding: 6px 12px; font-size: 10px; font-weight: 600; border: 2px solid #ddd; border-radius: 6px; background: #fff; cursor: pointer; }
    .filter-btn:hover { border-color: #999; }
    .filter-btn.active { background: #1a1a1a; color: #fff; border-color: #1a1a1a; }
    .filter-btn.global-btn.active { background: #00cdbe; border-color: #00cdbe; color: #1a1a1a; }
    .filter-btn.navigation-btn.active { background: #f5a623; border-color: #f5a623; color: #1a1a1a; }
    .filter-btn.surface-btn.active { background: #888; border-color: #888; color: #fff; }

    /* Dimension filter (device/state selection) */
    .dim-filter { display: flex; gap: 6px; flex-wrap: wrap; }
    .dim-btn { padding: 4px 10px; font-size: 9px; font-weight: 600; border: 1px solid #ccc; border-radius: 4px; background: #fff; cursor: pointer; }
    .dim-btn:hover { border-color: #666; }
    .dim-btn.active { background: #e3f2fd; border-color: #1976d2; color: #1565c0; }

    /* Sections */
    .section { background: #fff; border: 2px solid #1a1a1a; border-radius: 12px; padding: 16px; margin-bottom: 20px; }
    .section.hidden { display: none; }
    .section-header { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 16px; }
    .section-label { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; padding: 4px 10px; border-radius: 4px; flex-shrink: 0; }
    .section-title { font-size: 14px; font-weight: 600; }
    .section-desc { font-size: 10px; color: #666; }
    .section-intent { font-size: 9px; color: #00897b; font-style: italic; margin-top: 2px; }
    .global .section-label { background: #00cdbe; color: #1a1a1a; }
    .global { border-color: #00cdbe; }
    .navigation .section-label { background: #f5a623; color: #1a1a1a; }
    .navigation { border-color: #f5a623; }
    .surface .section-label { background: #888; color: #fff; }
    .surface { border-color: #888; }

    /* Device/State grid */
    .dim-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .dim-grid.state-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
    .dim-card { background: #fafafa; border-radius: 8px; padding: 12px; border: 1px solid #e0e0e0; }
    .dim-card.hidden { display: none; }
    .dim-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #ddd; }
    .dim-name { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .dim-users { font-size: 9px; color: #666; }
    .dim-users .engaged { font-weight: 700; color: #1976d2; }
    .dim-users .deduped { font-weight: 600; color: #7c3aed; }
    .dim-users .total { color: #888; }
    .global .dim-header { border-bottom-color: #00cdbe; }
    .navigation .dim-header { border-bottom-color: #f5a623; }
    .surface .dim-header { border-bottom-color: #888; }

    /* Metric table */
    .metric-table { width: 100%; border-collapse: collapse; font-size: 9px; }
    .metric-table th { text-align: left; padding: 4px 3px; font-size: 7px; font-weight: 600; color: #888; text-transform: uppercase; border-bottom: 1px solid #ddd; }
    .metric-table th:not(:first-child) { text-align: right; }
    .metric-table td { padding: 4px 3px; border-bottom: 1px solid #eee; }
    .metric-table td:not(:first-child) { text-align: right; font-family: 'SF Mono', Monaco, monospace; font-size: 8px; }
    .metric-table .outcome { font-weight: 500; color: #333; white-space: nowrap; }
    .metric-table .events { font-weight: 700; color: #1a1a1a; }
    .metric-table .users { color: #1976d2; font-weight: 600; }
    .metric-table .util { color: #1976d2; font-weight: 600; }
    .metric-table .int { color: #7c3aed; font-weight: 600; }
    .metric-table .total-row { font-weight: 700; border-top: 2px solid #ccc; background: #f5f5f5; }
    .metric-table .deduped-row { font-weight: 600; background: #f3e5f5; border-top: 1px dashed #9c27b0; }
    .metric-table .deduped-row td { color: #7b1fa2; }

    /* Footer */
    .footer { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-top: 20px; }
    .legend { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; font-size: 9px; line-height: 1.8; }
    .legend strong { color: #333; }
    .legend .util { color: #1976d2; }
    .legend .int { color: #7c3aed; }
    .legend .note { font-style: italic; color: #666; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; }
    .users-card { background: #e8f4fc; border: 1px solid #90caf9; border-radius: 8px; padding: 12px; }
    .users-card strong { font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; color: #333; display: block; margin-bottom: 8px; }
    .users-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .users-grid.state-users { grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); }
    .user-stat { text-align: center; padding: 6px; background: rgba(255,255,255,0.7); border-radius: 4px; }
    .user-stat .dim { font-size: 8px; color: #666; }
    .user-stat .count { font-size: 12px; font-weight: 700; color: #1565c0; font-family: 'SF Mono', Monaco, monospace; }
    .data-status { background: #e8f5e9; border: 1px solid #4caf50; border-radius: 6px; padding: 4px 10px; font-size: 10px; font-weight: 600; color: #2e7d32; }
    .export-btn { padding: 6px 14px; font-size: 10px; font-weight: 600; border: 2px solid #1976d2; border-radius: 6px; background: #fff; color: #1976d2; cursor: pointer; margin-left: auto; }
    .export-btn:hover { background: #1976d2; color: #fff; }

    /* Summary statistics */
    .summary-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; color: #fff; }
    .summary-title { font-size: 14px; font-weight: 700; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px; }
    .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .summary-toggle { padding: 4px 10px; font-size: 9px; font-weight: 600; border: 1px solid #ccc; border-radius: 4px; background: #fff; cursor: pointer; }
    .summary-toggle:hover { border-color: #666; }
    .summary-toggle.active { background: #667eea; border-color: #667eea; color: #fff; }
    .summary-section.hidden { display: none; }
    .summary-card { background: rgba(255,255,255,0.15); border-radius: 8px; padding: 12px; }
    .summary-card-title { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.9; margin-bottom: 8px; }
    .summary-big-number { font-size: 24px; font-weight: 700; font-family: 'SF Mono', Monaco, monospace; }
    .summary-breakdown { margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2); }
    .summary-breakdown-row { display: flex; justify-content: space-between; font-size: 10px; padding: 3px 0; }
    .summary-breakdown-label { opacity: 0.85; }
    .summary-breakdown-value { font-weight: 600; font-family: 'SF Mono', Monaco, monospace; }
    .summary-bar { height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; margin-top: 4px; overflow: hidden; }
    .summary-bar-fill { height: 100%; background: rgba(255,255,255,0.8); border-radius: 2px; }
  </style>
</head>
<body>
  <div id="app"><div class="loading">Loading...</div></div>

  <script>
    var dashboardData = {
      viewMode: 'device', // 'device' or 'state'
      devices: ['Desktop', 'mWeb', 'iOS', 'Android'],
      states: [], // Will be populated from data
      selectedDims: [], // Selected devices or states
      buckets: {
        'GLOBAL_SEARCH': { label: 'Global', title: 'Global Search', desc: 'User typed a query', intent: 'Intent captured via query', css: 'global' },
        'NAVIGATION_SEARCH': { label: 'Navigation', title: 'Navigation Search', desc: 'No query typed — search bar used as navigation shortcut', css: 'navigation' },
        'SPECIFIC_SEARCH': { label: 'Surface', title: 'Surface Search', desc: 'Search within specific contexts (menus, addresses, etc.)', css: 'surface' }
      },
      totalUsers: {},
      metrics: {},
      dedupedUsers: {}, // Deduped users per bucket+dimension
      totalVolume: {}, // Total events across all buckets per dimension
      rawData: null, // Store raw Tableau data for export
      summary: {
        totalVolume: 0,
        bucketVolume: { GLOBAL_SEARCH: 0, NAVIGATION_SEARCH: 0, SPECIFIC_SEARCH: 0 },
        serpVolume: { total: 0, byDevice: {} },
        listingMenuVolume: { total: 0, byDevice: {} },
        searchBarOutcomes: {} // Combined Global + Nav outcomes (NAV_ prefix removed)
      },
      showSummary: true
    };

    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
      if (num >= 1000) return Math.round(num / 1000) + 'K';
      return num.toString();
    }

    function parseData(data) {
      // Store raw data for export
      dashboardData.rawData = data;

      var cols = {};
      data.columns.forEach(function(c, i) {
        cols[c.fieldName.toLowerCase().replace(/[\s_]/g, '')] = i;
      });

      // Check if we have state data
      var hasState = cols['state'] !== undefined || cols['stateabv'] !== undefined;
      var stateCol = cols['state'] || cols['stateabv'];

      dashboardData.metrics = {};
      dashboardData.totalUsers = {};
      dashboardData.dedupedUsers = {};
      dashboardData.totalVolume = {};
      var statesSet = {};

      data.data.forEach(function(row) {
        var device = row[cols['device']] ? row[cols['device']].value : null;
        var state = stateCol !== undefined && row[stateCol] ? row[stateCol].value : null;
        var bucket = row[cols['searchbucket']].value;
        var outcome = row[cols['outcometype']].value;
        var events = parseFloat(row[cols['eventcount']].value) || 0;
        var users = parseFloat(row[cols['uniqueusers']].value) || 0;
        var total = parseFloat(row[cols['totalusers']].value) || 0;
        var pct = parseFloat(row[cols['pctusersengaged']].value) || 0;
        var intensity = parseFloat(row[cols['intensity']].value) || 0;
        var dedupedBucket = row[cols['dedupedbucketusers']] ? parseFloat(row[cols['dedupedbucketusers']].value) || 0 : null;

        // Handle device data
        if (device) {
          dashboardData.totalUsers[device] = total;
          var key = device + '|' + bucket;
          if (!dashboardData.metrics[key]) {
            dashboardData.metrics[key] = { dim: device, dimType: 'device', bucket: bucket, outcomes: [], totalEvents: 0, totalUsers: 0 };
          }
          dashboardData.metrics[key].outcomes.push({ outcome: outcome, events: events, users: users, pct: pct, intensity: intensity });
          dashboardData.metrics[key].totalEvents += events;
          dashboardData.metrics[key].totalUsers += users;
          if (dedupedBucket !== null) {
            dashboardData.dedupedUsers[key] = dedupedBucket;
          }
          // Track total volume across all buckets
          dashboardData.totalVolume[device] = (dashboardData.totalVolume[device] || 0) + events;
        }

        // Handle state data (filter out Tableau's %null% representation)
        if (state && state !== '%null%' && state.toLowerCase() !== 'null') {
          statesSet[state] = true;
          dashboardData.totalUsers['state_' + state] = total;
          var stateKey = 'state_' + state + '|' + bucket;
          if (!dashboardData.metrics[stateKey]) {
            dashboardData.metrics[stateKey] = { dim: state, dimType: 'state', bucket: bucket, outcomes: [], totalEvents: 0, totalUsers: 0 };
          }
          dashboardData.metrics[stateKey].outcomes.push({ outcome: outcome, events: events, users: users, pct: pct, intensity: intensity });
          dashboardData.metrics[stateKey].totalEvents += events;
          dashboardData.metrics[stateKey].totalUsers += users;
          if (dedupedBucket !== null) {
            dashboardData.dedupedUsers[stateKey] = dedupedBucket;
          }
          // Track total volume across all buckets for state
          var stateVolKey = 'state_' + state;
          dashboardData.totalVolume[stateVolKey] = (dashboardData.totalVolume[stateVolKey] || 0) + events;
        }
      });

      dashboardData.states = Object.keys(statesSet).sort();

      // Sort outcomes by events
      Object.keys(dashboardData.metrics).forEach(function(k) {
        dashboardData.metrics[k].outcomes.sort(function(a, b) { return b.events - a.events; });
      });

      // Calculate summary statistics (device-level only)
      dashboardData.summary = {
        totalVolume: 0,
        bucketVolume: { GLOBAL_SEARCH: 0, NAVIGATION_SEARCH: 0, SPECIFIC_SEARCH: 0 },
        serpVolume: { total: 0, byDevice: {} },
        listingMenuVolume: { total: 0, byDevice: {} },
        searchBarOutcomes: {}
      };

      Object.keys(dashboardData.metrics).forEach(function(k) {
        var m = dashboardData.metrics[k];
        // Only count device-level data for summary (avoid double-counting with state data)
        if (m.dimType === 'device') {
          dashboardData.summary.bucketVolume[m.bucket] = (dashboardData.summary.bucketVolume[m.bucket] || 0) + m.totalEvents;
          dashboardData.summary.totalVolume += m.totalEvents;

          // Track SERP and LISTING_MENU specifically
          m.outcomes.forEach(function(o) {
            if (o.outcome === 'SERP') {
              dashboardData.summary.serpVolume.total += o.events;
              dashboardData.summary.serpVolume.byDevice[m.dim] = (dashboardData.summary.serpVolume.byDevice[m.dim] || 0) + o.events;
            }
            if (o.outcome === 'LISTING_MENU') {
              dashboardData.summary.listingMenuVolume.total += o.events;
              dashboardData.summary.listingMenuVolume.byDevice[m.dim] = (dashboardData.summary.listingMenuVolume.byDevice[m.dim] || 0) + o.events;
            }

            // Track search bar outcomes (Global + Navigation combined, remove NAV_ prefix)
            if (m.bucket === 'GLOBAL_SEARCH' || m.bucket === 'NAVIGATION_SEARCH') {
              var outcomeKey = o.outcome.replace(/^NAV_/, '');
              dashboardData.summary.searchBarOutcomes[outcomeKey] = (dashboardData.summary.searchBarOutcomes[outcomeKey] || 0) + o.events;
            }
          });
        }
      });

      // Initialize selected dimensions
      if (dashboardData.selectedDims.length === 0) {
        dashboardData.selectedDims = dashboardData.devices.slice();
      }
    }

    function render() {
      var isDevice = dashboardData.viewMode === 'device';
      var dims = isDevice ? dashboardData.devices : dashboardData.states;
      var dimLabel = isDevice ? 'Device' : 'State';

      var html = '<h1>Search Event Taxonomy</h1>';
      html += '<div class="subtitle">' + (isDevice ? 'Breakout by Device' : 'Breakout by State') + '</div>';

      // Control bar with view toggle
      html += '<div class="control-bar">';
      html += '<div class="control-group"><span class="control-label">View:</span>';
      html += '<div class="view-toggle">';
      html += '<button class="view-btn' + (isDevice ? ' active' : '') + '" onclick="setView(\'device\')">Device</button>';
      html += '<button class="view-btn' + (!isDevice ? ' active' : '') + '" onclick="setView(\'state\')"' + (dashboardData.states.length === 0 ? ' disabled title="No state data available"' : '') + '>State</button>';
      html += '</div></div>';

      // Dimension filter
      html += '<div class="control-group"><span class="control-label">' + dimLabel + ':</span>';
      html += '<div class="dim-filter">';
      html += '<button class="dim-btn' + (dashboardData.selectedDims.length === dims.length ? ' active' : '') + '" onclick="toggleAllDims()">All</button>';
      html += '<button class="dim-btn' + (dashboardData.selectedDims.length === 0 ? ' active' : '') + '" onclick="selectNone()">None</button>';
      if (!isDevice && dims.length > 5) {
        html += '<button class="dim-btn" onclick="selectTopN(5)">Top 5</button>';
        html += '<button class="dim-btn" onclick="selectTopN(10)">Top 10</button>';
      }
      dims.forEach(function(d) {
        var isSelected = dashboardData.selectedDims.indexOf(d) !== -1;
        html += '<button class="dim-btn' + (isSelected ? ' active' : '') + '" onclick="toggleDim(\'' + d + '\')">' + d + '</button>';
      });
      html += '</div></div>';

      html += '<button class="summary-toggle' + (dashboardData.showSummary ? ' active' : '') + '" onclick="toggleSummary()">Summary</button>';
      html += '<div class="data-status">Live from Tableau</div>';
      html += '<button class="export-btn" onclick="exportCSV()">Export CSV</button>';
      html += '</div>';

      // Bucket filter
      html += '<div class="filter-bar"><div class="filter-group"><span class="filter-label">Bucket:</span>';
      html += '<button class="filter-btn active" onclick="filterBucket(\'all\')">All</button>';
      html += '<button class="filter-btn global-btn" onclick="filterBucket(\'global\')">Global Search</button>';
      html += '<button class="filter-btn navigation-btn" onclick="filterBucket(\'navigation\')">Navigation</button>';
      html += '<button class="filter-btn surface-btn" onclick="filterBucket(\'surface\')">Surface</button>';
      html += '</div></div>';

      // Summary statistics section
      var s = dashboardData.summary;
      html += '<div class="summary-section' + (dashboardData.showSummary ? '' : ' hidden') + '">';
      html += '<div class="summary-title">Summary Statistics</div>';
      html += '<div class="summary-grid">';

      // Total volume card
      html += '<div class="summary-card">';
      html += '<div class="summary-card-title">Total Search Volume</div>';
      html += '<div class="summary-big-number">' + formatNumber(s.totalVolume) + '</div>';
      html += '<div class="summary-breakdown">';
      var buckets = ['GLOBAL_SEARCH', 'NAVIGATION_SEARCH', 'SPECIFIC_SEARCH'];
      var bucketLabels = { GLOBAL_SEARCH: 'Global', NAVIGATION_SEARCH: 'Navigation', SPECIFIC_SEARCH: 'Surface' };
      buckets.forEach(function(b) {
        var pct = s.totalVolume > 0 ? (100 * s.bucketVolume[b] / s.totalVolume).toFixed(1) : 0;
        html += '<div class="summary-breakdown-row"><span class="summary-breakdown-label">' + bucketLabels[b] + '</span><span class="summary-breakdown-value">' + pct + '%</span></div>';
        html += '<div class="summary-bar"><div class="summary-bar-fill" style="width:' + pct + '%"></div></div>';
      });
      html += '</div></div>';

      // SERP volume card
      html += '<div class="summary-card">';
      html += '<div class="summary-card-title">SERP Volume (Global Search)</div>';
      html += '<div class="summary-big-number">' + formatNumber(s.serpVolume.total) + '</div>';
      html += '<div class="summary-breakdown">';
      dashboardData.devices.forEach(function(d) {
        var vol = s.serpVolume.byDevice[d] || 0;
        var pct = s.serpVolume.total > 0 ? (100 * vol / s.serpVolume.total).toFixed(1) : 0;
        html += '<div class="summary-breakdown-row"><span class="summary-breakdown-label">' + d + '</span><span class="summary-breakdown-value">' + pct + '%</span></div>';
        html += '<div class="summary-bar"><div class="summary-bar-fill" style="width:' + pct + '%"></div></div>';
      });
      html += '</div></div>';

      // Search bar outcomes card (Global + Navigation combined)
      html += '<div class="summary-card">';
      html += '<div class="summary-card-title">Outcomes After Clicking Search Bar (Global + Navigation)</div>';
      var searchBarTotal = Object.values(s.searchBarOutcomes).reduce(function(a, b) { return a + b; }, 0);
      html += '<div class="summary-big-number">' + formatNumber(searchBarTotal) + '</div>';
      html += '<div class="summary-breakdown">';
      // Sort outcomes by volume descending
      var sortedOutcomes = Object.keys(s.searchBarOutcomes).sort(function(a, b) {
        return s.searchBarOutcomes[b] - s.searchBarOutcomes[a];
      });
      sortedOutcomes.slice(0, 5).forEach(function(outcome) {
        var vol = s.searchBarOutcomes[outcome];
        var pct = searchBarTotal > 0 ? (100 * vol / searchBarTotal).toFixed(1) : 0;
        html += '<div class="summary-breakdown-row"><span class="summary-breakdown-label">' + outcome + '</span><span class="summary-breakdown-value">' + pct + '%</span></div>';
        html += '<div class="summary-bar"><div class="summary-bar-fill" style="width:' + pct + '%"></div></div>';
      });
      html += '</div></div>';

      // Listing Menu volume card
      html += '<div class="summary-card">';
      html += '<div class="summary-card-title">Listing Menu Volume (Surface Search)</div>';
      html += '<div class="summary-big-number">' + formatNumber(s.listingMenuVolume.total) + '</div>';
      html += '<div class="summary-breakdown">';
      dashboardData.devices.forEach(function(d) {
        var vol = s.listingMenuVolume.byDevice[d] || 0;
        var pct = s.listingMenuVolume.total > 0 ? (100 * vol / s.listingMenuVolume.total).toFixed(1) : 0;
        html += '<div class="summary-breakdown-row"><span class="summary-breakdown-label">' + d + '</span><span class="summary-breakdown-value">' + pct + '%</span></div>';
        html += '<div class="summary-bar"><div class="summary-bar-fill" style="width:' + pct + '%"></div></div>';
      });
      html += '</div></div>';

      html += '</div></div>';

      // Sections for each bucket
      ['GLOBAL_SEARCH', 'NAVIGATION_SEARCH', 'SPECIFIC_SEARCH'].forEach(function(bucketKey) {
        var info = dashboardData.buckets[bucketKey];
        html += '<div class="section ' + info.css + '" data-bucket="' + info.css + '">';
        html += '<div class="section-header"><div class="section-label">' + info.label + '</div><div>';
        html += '<div class="section-title">' + info.title + '</div>';
        html += '<div class="section-desc">' + info.desc + '</div>';
        if (info.intent) {
          html += '<div class="section-intent">' + info.intent + '</div>';
        }
        html += '</div></div>';
        html += '<div class="dim-grid' + (!isDevice ? ' state-grid' : '') + '">';

        dims.forEach(function(dim) {
          var keyPrefix = isDevice ? dim : 'state_' + dim;
          var key = keyPrefix + '|' + bucketKey;
          var m = dashboardData.metrics[key];
          var totalDim = dashboardData.totalUsers[keyPrefix] || 0;
          var dedupedUsers = dashboardData.dedupedUsers[key];
          var isVisible = dashboardData.selectedDims.indexOf(dim) !== -1;

          html += '<div class="dim-card' + (!isVisible ? ' hidden' : '') + '" data-dim="' + dim + '">';
          html += '<div class="dim-header"><span class="dim-name">' + dim + '</span>';
          html += '<span class="dim-users">';
          if (dedupedUsers !== undefined) {
            html += '<span class="deduped" title="Deduped users in bucket">' + formatNumber(dedupedUsers) + '</span>/';
          }
          html += '<span class="total">' + formatNumber(totalDim) + '</span></span></div>';
          html += '<table class="metric-table"><thead><tr><th>Outcome</th><th>Events</th><th>Users</th><th>%Engaged</th><th>Per User</th></tr></thead><tbody>';

          if (m && m.outcomes.length > 0) {
            m.outcomes.forEach(function(o) {
              html += '<tr><td class="outcome">' + o.outcome + '</td><td class="events">' + formatNumber(o.events) + '</td><td class="users">' + formatNumber(o.users) + '</td><td class="util">' + o.pct.toFixed(2) + '%</td><td class="int">' + o.intensity.toFixed(1) + '</td></tr>';
            });
            html += '<tr class="total-row"><td class="outcome">SUM</td><td class="events">' + formatNumber(m.totalEvents) + '</td><td class="users">' + formatNumber(m.totalUsers) + '*</td><td>-</td><td>-</td></tr>';
            if (dedupedUsers !== undefined) {
              html += '<tr class="deduped-row"><td class="outcome">UNIQUE</td><td>-</td><td class="users">' + formatNumber(dedupedUsers) + '</td><td>-</td><td>-</td></tr>';
            }
          } else {
            html += '<tr><td colspan="5" style="text-align:center;color:#ccc;">No data</td></tr>';
          }
          html += '</tbody></table></div>';
        });
        html += '</div></div>';
      });

      // Footer with legend and totals
      html += '<div class="footer">';
      html += '<div class="legend">';
      html += '<strong>Metric Definitions</strong><br>';
      html += '<strong>Outcome</strong> = resultant page/surface after click<br>';
      html += '<strong>Events</strong> = gross event count<br>';
      html += '<span class="util"><strong>Users</strong></span> = distinct users who performed this action<br>';
      html += '<span class="util"><strong>%Engaged</strong></span> = % of ' + dimLabel.toLowerCase() + ' users who engaged with this outcome<br>';
      html += '<span class="int"><strong>Per User</strong></span> = events per engaged user<br>';
      html += '<div class="note">* SUM of users is not deduped — users can have multiple outcome types within a bucket. UNIQUE row shows deduped count.</div>';
      html += '</div>';

      // Users by dimension card
      html += '<div class="users-card"><strong>Total Users by ' + dimLabel + '</strong>';
      html += '<div class="users-grid' + (!isDevice ? ' state-users' : '') + '">';
      dims.forEach(function(d) {
        if (dashboardData.selectedDims.indexOf(d) !== -1) {
          var keyPrefix = isDevice ? d : 'state_' + d;
          html += '<div class="user-stat"><div class="dim">' + d + '</div><div class="count">' + formatNumber(dashboardData.totalUsers[keyPrefix] || 0) + '</div></div>';
        }
      });
      html += '</div></div></div>';

      document.getElementById('app').innerHTML = html;
    }

    window.setView = function(mode) {
      dashboardData.viewMode = mode;
      var dims = mode === 'device' ? dashboardData.devices : dashboardData.states;
      dashboardData.selectedDims = dims.slice();
      render();
    };

    window.toggleDim = function(dim) {
      var idx = dashboardData.selectedDims.indexOf(dim);
      if (idx === -1) {
        dashboardData.selectedDims.push(dim);
      } else if (dashboardData.selectedDims.length > 1) {
        dashboardData.selectedDims.splice(idx, 1);
      }
      render();
    };

    window.toggleAllDims = function() {
      var dims = dashboardData.viewMode === 'device' ? dashboardData.devices : dashboardData.states;
      dashboardData.selectedDims = dims.slice();
      render();
    };

    window.selectNone = function() {
      dashboardData.selectedDims = [];
      render();
    };

    window.toggleSummary = function() {
      dashboardData.showSummary = !dashboardData.showSummary;
      render();
    };

    window.selectTopN = function(n) {
      var isDevice = dashboardData.viewMode === 'device';
      var dims = isDevice ? dashboardData.devices : dashboardData.states;

      // Sort dimensions by total volume (descending)
      var sorted = dims.slice().sort(function(a, b) {
        var keyA = isDevice ? a : 'state_' + a;
        var keyB = isDevice ? b : 'state_' + b;
        return (dashboardData.totalVolume[keyB] || 0) - (dashboardData.totalVolume[keyA] || 0);
      });

      dashboardData.selectedDims = sorted.slice(0, n);
      render();
    };

    window.filterBucket = function(f) {
      document.querySelectorAll('.filter-bar .filter-btn').forEach(function(b) { b.classList.remove('active'); });
      event.target.classList.add('active');
      document.querySelectorAll('.section').forEach(function(s) {
        s.classList.toggle('hidden', f !== 'all' && s.dataset.bucket !== f);
      });
    };

    window.exportCSV = function() {
      if (!dashboardData.rawData) {
        alert('No data available to export');
        return;
      }

      var data = dashboardData.rawData;
      var rows = [];

      // Header row
      var headers = data.columns.map(function(c) { return c.fieldName; });
      rows.push(headers.join(','));

      // Data rows
      data.data.forEach(function(row) {
        var values = row.map(function(cell) {
          var val = cell.value;
          // Escape quotes and wrap in quotes if contains comma or quote
          if (typeof val === 'string' && (val.indexOf(',') !== -1 || val.indexOf('"') !== -1)) {
            val = '"' + val.replace(/"/g, '""') + '"';
          }
          return val;
        });
        rows.push(values.join(','));
      });

      var csvContent = rows.join('\n');
      var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      var url = URL.createObjectURL(blob);
      var link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'search_taxonomy_data_' + new Date().toISOString().slice(0,10) + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    // Initialize
    if (typeof tableau !== 'undefined') {
      tableau.extensions.initializeAsync().then(function() {
        var ws = tableau.extensions.dashboardContent.dashboard.worksheets[0];
        ws.getSummaryDataAsync().then(function(data) {
          parseData(data);
          render();
        });
        ws.addEventListener(tableau.TableauEventType.SummaryDataChanged, function() {
          ws.getSummaryDataAsync().then(function(data) { parseData(data); render(); });
        });
      });
    } else {
      document.getElementById('app').innerHTML = '<div class="error">Tableau API not loaded</div>';
    }
  </script>
</body>
</html>
